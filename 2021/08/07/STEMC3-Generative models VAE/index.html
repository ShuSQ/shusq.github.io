<!DOCTYPE html>
<html lang="en">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  
  <title>STEMC3 - Generative models VAE using convolutional layers - Shu-Creative Computing</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/cursor.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

<meta name="generator" content="Hexo 5.2.0"></head>


    <body>
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Shu&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/categories/essays">Thinking</a>
            
            
            
            <a class="nav-item" href="/categories/pcomp">Pcomp&amp;AVCE</a>
            
            
            
            <a class="nav-item" href="/categories/coding">Coding</a>
            
            
            
            <a class="nav-item" href="/categories/portfolio">Portfolio</a>
            
            
            
            <a class="nav-item" href="/contact">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/ShuSQ" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/shusq" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.instagram.com/cheese_shu/" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            
            
            
            
            
            <span>August</span>
            
            
            
            
            
            <span>7,</span>
            <span>2021</span>
        </div>
        

        <h2 class="title">STEMC3 - Generative models VAE using convolutional layers</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <blockquote>
<p>Try to understand what is VAE and how it run by Keras.</p>
</blockquote>
<p><img src="https://cdn-images-1.medium.com/max/800/1*iLuMGbZrf5ssh83s7tBiOQ.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Lambda, Input, Dense</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Model</span><br><span class="line"><span class="keyword">from</span> keras.datasets <span class="keyword">import</span> mnist</span><br><span class="line"><span class="keyword">from</span> keras.losses <span class="keyword">import</span> mse, binary_crossentropy</span><br><span class="line"><span class="keyword">from</span> keras.utils.vis_utils <span class="keyword">import</span> plot_model</span><br><span class="line"><span class="keyword">from</span> keras <span class="keyword">import</span> backend <span class="keyword">as</span> K</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Conv2D, MaxPooling2D, UpSampling2D, Input</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Reshape, Flatten, BatchNormalization, Activation</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> os</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sampling</span>(<span class="params">args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Reparameterization trick by sampling from an isotropic unit Gaussian.</span></span><br><span class="line"><span class="string">    # Uses (z_mean, z_log_var) to sample z, the vector encoding a digit.</span></span><br><span class="line"><span class="string">    # Some visualizations of the idea are available at https://ijdykeman.github.io/assets/cvae_figures/vae_diagram.svg</span></span><br><span class="line"><span class="string">    #                                               or https://miro.medium.com/max/875/1*gA2JdLZJ12gQtnqakU7KAQ.png</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Arguments</span></span><br><span class="line"><span class="string">        args (tensor): mean and log of variance of Q(z|X)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Returns</span></span><br><span class="line"><span class="string">        z (tensor): sampled latent vector</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    z_mean, z_log_var = args</span><br><span class="line">    batch = K.shape(z_mean)[<span class="number">0</span>]</span><br><span class="line">    dim = K.int_shape(z_mean)[<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># by default, random_normal has mean = 0 and std = 1.0</span></span><br><span class="line">    epsilon = K.random_normal(shape=(batch, dim))</span><br><span class="line">    <span class="keyword">return</span> z_mean + K.exp(<span class="number">0.5</span> * z_log_var) * epsilon</span><br></pre></td></tr></table></figure>

<h3 id="Choose-dataset"><a href="#Choose-dataset" class="headerlink" title="Choose dataset:"></a>Choose dataset:</h3><p>We will use a dataset with the shape such as this:</p>
<blockquote>
<p>image pixels: (28, 28)</p>
</blockquote>
<blockquote>
<p>data: (N_number_of_samples, 28, 28, 1)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MNIST dataset</span></span><br><span class="line">(x_train, y_train), (x_test, y_test) = mnist.load_data()</span><br><span class="line"></span><br><span class="line">image_size = x_train.shape[<span class="number">1</span>]</span><br><span class="line"><span class="comment"># original_dim = image_size * image_size</span></span><br><span class="line"><span class="comment"># x_train = np.reshape(x_train, [-1, original_dim])</span></span><br><span class="line"><span class="comment"># x_test = np.reshape(x_test, [-1, original_dim])</span></span><br><span class="line">x_train = x_train.astype(<span class="string">&#x27;float32&#x27;</span>) / <span class="number">255</span></span><br><span class="line">x_test = x_test.astype(<span class="string">&#x27;float32&#x27;</span>) / <span class="number">255</span></span><br><span class="line">input_shape = (<span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>)</span><br><span class="line">output_channels = <span class="number">1</span></span><br><span class="line">x_train = np.reshape(x_train, x_train.shape+(<span class="number">1</span>,))</span><br><span class="line">x_test = np.reshape(x_test, x_test.shape+(<span class="number">1</span>,))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;We loaded the MNIST dataset:&quot;</span>)</span><br><span class="line">print(<span class="string">&quot;input_shape:&quot;</span>, input_shape)</span><br><span class="line">print(<span class="string">&quot;x_train:&quot;</span>, x_train.shape)</span><br><span class="line">print(<span class="string">&quot;x_test:&quot;</span>, x_test.shape)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Downloading data from <a target="_blank" rel="noopener" href="https://storage.googleapis.com/tensorflow/tf-keras-datasets/mnist.npz">https://storage.googleapis.com/tensorflow/tf-keras-datasets/mnist.npz</a> 11493376/11490434 [==============================] - 0s 0us/step </p>
<p>11501568/11490434 [==============================] - 0s 0us/step </p>
<p>We loaded the MNIST dataset: </p>
<p>input_shape: (28, 28, 1) </p>
<p>x_train: (60000, 28, 28, 1) </p>
<p>x_test: (10000, 28, 28, 1)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Let&#x27;s look at one sample:</span></span><br><span class="line">x1 = x_test[<span class="number">9000</span>]</span><br><span class="line">print(x1.shape, <span class="string">&quot;stats:&quot;</span>, np.<span class="built_in">max</span>(x1), np.<span class="built_in">min</span>(x1), np.mean(x1))</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">4</span>,<span class="number">4</span>))</span><br><span class="line">plt.imshow(x1[:,:,<span class="number">0</span>], cmap=<span class="string">&#x27;gray&#x27;</span>, vmin=<span class="number">0.0</span>, vmax=<span class="number">1.0</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*DY8kP_7iH1koMT5IXZeuKA.png"></p>
<h3 id="Alternative-dataset-QuickDraw"><a href="#Alternative-dataset-QuickDraw" class="headerlink" title="Alternative dataset - QuickDraw"></a>Alternative dataset - QuickDraw</h3><p>We can also use the QuickDraw dataset by @Zaid Alyafeal which was used in the ML4A guide for regular AutoEncoder.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!git clone https://github.com/zaidalyafeai/QuickDraw10</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Cloning into ‘QuickDraw10’… </p>
<p>remote: Enumerating objects: 53, done. </p>
<p>remote: Total 53 (delta 0), reused 0 (delta 0), pack-reused 53 </p>
<p>Unpacking objects: 100% (53/53), done.</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">train_data = np.load(<span class="string">&#x27;QuickDraw10/dataset/train-ubyte.npz&#x27;</span>)</span><br><span class="line">test_data  = np.load(<span class="string">&#x27;QuickDraw10/dataset/test-ubyte.npz&#x27;</span>)</span><br><span class="line"></span><br><span class="line">x_train, y_train = train_data[<span class="string">&#x27;a&#x27;</span>], test_data[<span class="string">&#x27;b&#x27;</span>]</span><br><span class="line">x_test,  y_test  = test_data[<span class="string">&#x27;a&#x27;</span>],  test_data[<span class="string">&#x27;b&#x27;</span>]</span><br><span class="line"></span><br><span class="line">x_train = np.expand_dims(x_train.astype(<span class="string">&#x27;float32&#x27;</span>) / <span class="number">255.</span>, <span class="number">3</span>)</span><br><span class="line">x_test  = np.expand_dims(x_test.astype(<span class="string">&#x27;float32&#x27;</span>) / <span class="number">255.</span> , <span class="number">3</span>)</span><br><span class="line">print(x_train.shape)</span><br><span class="line">print(x_test.shape)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(80000, 28, 28, 1) </p>
<p>(20000, 28, 28, 1)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Let&#x27;s look at one sample:</span></span><br><span class="line">x1 = x_test[<span class="number">0</span>] <span class="comment"># 0 - umbrella</span></span><br><span class="line">print(x1.shape, <span class="string">&quot;stats:&quot;</span>, np.<span class="built_in">max</span>(x1), np.<span class="built_in">min</span>(x1), np.mean(x1))</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">4</span>,<span class="number">4</span>))</span><br><span class="line">plt.imshow(x1[:,:,<span class="number">0</span>], cmap=<span class="string">&#x27;gray&#x27;</span>, vmin=<span class="number">0.0</span>, vmax=<span class="number">1.0</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*BLDtlfswiHBC9WS3IeOgRQ.png"></p>
<h3 id="Alternative-dataset-CIFAR10"><a href="#Alternative-dataset-CIFAR10" class="headerlink" title="Alternative dataset - CIFAR10"></a>Alternative dataset - CIFAR10</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line">train, test = tf.keras.datasets.cifar10.load_data()</span><br><span class="line">x_train, y_train = train</span><br><span class="line">x_test, y_test = test</span><br><span class="line"></span><br><span class="line">x_train = x_train.astype(<span class="string">&#x27;float32&#x27;</span>) / <span class="number">255</span></span><br><span class="line">x_test = x_test.astype(<span class="string">&#x27;float32&#x27;</span>) / <span class="number">255</span></span><br><span class="line"><span class="comment"># print(x_train.shape, y_train.shape, x_test.shape, y_test.shape)</span></span><br><span class="line">output_channels = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;we loaded the MNIST dataset:&quot;</span>)</span><br><span class="line">print(<span class="string">&quot;input_shape:&quot;</span>, input_shape)</span><br><span class="line">print(<span class="string">&quot;x_train:&quot;</span>, x_train.shape)</span><br><span class="line">print(<span class="string">&quot;x_test:&quot;</span>, x_test.shape)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Downloading data from <a target="_blank" rel="noopener" href="https://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz">https://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz</a> 170500096/170498071 [==============================] - 4s 0us/step </p>
<p>we loaded the MNIST dataset: </p>
<p>input_shape: (28, 28, 1) </p>
<p>x_train: (50000, 32, 32, 3) </p>
<p>x_test: (10000, 32, 32, 3)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line">x_train = [cv2.resize(image, (<span class="number">28</span>, <span class="number">28</span>), interpolation=cv2.INTER_CUBIC) <span class="keyword">for</span> image <span class="keyword">in</span> x_train]</span><br><span class="line">x_train = np.asarray(x_train)</span><br><span class="line">x_test = [cv2.resize(image, (<span class="number">28</span>, <span class="number">28</span>), interpolation=cv2.INTER_CUBIC) <span class="keyword">for</span> image <span class="keyword">in</span> x_test]</span><br><span class="line">x_test = np.asarray(x_test)</span><br><span class="line">input_shape = x_train[<span class="number">0</span>].shape</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;x_train:&quot;</span>, x_train.shape)</span><br><span class="line">print(<span class="string">&quot;x_test:&quot;</span>, x_test.shape)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>x_train: (50000, 28, 28, 3) </p>
<p>x_test: (10000, 28, 28, 3)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x1 = x_test[<span class="number">1</span>]</span><br><span class="line">print(x1.shape, <span class="string">&quot;stats:&quot;</span>, np.<span class="built_in">max</span>(x1), np.<span class="built_in">min</span>(x1), np.mean(x1))</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">4</span>,<span class="number">4</span>))</span><br><span class="line">plt.imshow(x1[:,:], vmin=<span class="number">0.0</span>, vmax=<span class="number">1.0</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers). </p>
</blockquote>
<p><img src="https://cdn-images-1.medium.com/max/800/1*HXhFMiBDQuJL-kAODKcSBA.png"></p>
<h3 id="Building-the-model"><a href="#Building-the-model" class="headerlink" title="Building the model:"></a>Building the model:</h3><p>Image -&gt; Encoder -&gt; latent vector representation -&gt; Decoder -&gt; Reconstruction</p>
<h4 id="Convolutional-VAE"><a href="#Convolutional-VAE" class="headerlink" title="Convolutional VAE"></a>Convolutional VAE</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># network parameters</span></span><br><span class="line"><span class="comment"># latent_dim = 10</span></span><br><span class="line">latent_dim = <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># VAE model = encoder + decoder</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build encoder model</span></span><br><span class="line">inputs = Input(shape=input_shape, name=<span class="string">&#x27;encoder_input&#x27;</span>)</span><br><span class="line"></span><br><span class="line">kernels = <span class="number">26</span></span><br><span class="line">x = Conv2D(kernels, (<span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>, padding=<span class="string">&#x27;same&#x27;</span>)(inputs)</span><br><span class="line"><span class="comment"># x = Conv2D(kernels, (3), activation=&#x27;relu&#x27;, padding=&#x27;same&#x27;)(x)</span></span><br><span class="line">x = MaxPooling2D((<span class="number">2</span>), padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line">x = Conv2D(<span class="built_in">int</span>(kernels/<span class="number">2</span>), (<span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>, padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line"><span class="comment"># x = Conv2D(int(kernels/2), (3), activation=&#x27;relu&#x27;, padding=&#x27;same&#x27;)(x)</span></span><br><span class="line">x = MaxPooling2D((<span class="number">2</span>), padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line">x = Conv2D(<span class="built_in">int</span>(kernels/<span class="number">4</span>), (<span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>, padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line">x = MaxPooling2D((<span class="number">2</span>), padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line">intermediate_conv_shape = x.get_shape()</span><br><span class="line">x = Flatten()(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># optionally BN?</span></span><br><span class="line">x = BatchNormalization()(x)</span><br><span class="line">x = Activation(<span class="string">&quot;relu&quot;</span>)(x)</span><br><span class="line"></span><br><span class="line">_,n,m,o = intermediate_conv_shape <span class="comment"># (None, 4, 4, 6) #96</span></span><br><span class="line">intermediate_dim = n*m*o</span><br><span class="line"></span><br><span class="line"><span class="comment"># some fully connected layers in the middle?</span></span><br><span class="line"><span class="comment"># x= Dense(intermediate_dim, activation=&#x27;relu)(x)</span></span><br><span class="line"></span><br><span class="line">z_mean = Dense(latent_dim, name=<span class="string">&#x27;z_mean&#x27;</span>)(x)</span><br><span class="line">z_log_var = Dense(latent_dim, name=<span class="string">&#x27;z_log_var&#x27;</span>)(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># use reparameterization trick to push the sampling out as input</span></span><br><span class="line"><span class="comment"># note that &quot;output_shape&quot; is not necessary with the TensorFlow backend</span></span><br><span class="line">z = Lambda(sampling, output_shape=(latent_dim,), name=<span class="string">&#x27;z&#x27;</span>)([z_mean, z_log_var])</span><br><span class="line"></span><br><span class="line"><span class="comment"># instantiate encoder model</span></span><br><span class="line">encoder = Model(inputs, [z_mean, z_log_var, z], name=<span class="string">&#x27;encoder&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># build decoder model</span></span><br><span class="line">latent_inputs = Input(shape=(latent_dim,), name=<span class="string">&#x27;z_sampling&#x27;</span>)</span><br><span class="line">x = Dense(intermediate_dim, activation=<span class="string">&#x27;relu&#x27;</span>)(latent_inputs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># optionally BN?</span></span><br><span class="line">x = BatchNormalization()(x)</span><br><span class="line">x = Activation(<span class="string">&quot;relu&quot;</span>)(x)</span><br><span class="line"></span><br><span class="line">x = Reshape((n,m,o))(x)</span><br><span class="line">x = Conv2D(<span class="built_in">int</span>(kernels/<span class="number">4</span>), (<span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>, padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line">x = UpSampling2D((<span class="number">2</span>))(x)</span><br><span class="line">x = Conv2D(<span class="built_in">int</span>(kernels/<span class="number">2</span>), (<span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>, padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line">x = UpSampling2D((<span class="number">2</span>))(x)</span><br><span class="line">x = Conv2D(<span class="built_in">int</span>(kernels), (<span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>)(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># x = Conv2D(int(kernels), (3), activation=&#x27;relu&#x27;, padding=&#x27;same&#x27;)(x)</span></span><br><span class="line">x = UpSampling2D((<span class="number">2</span>))(x)</span><br><span class="line"><span class="comment"># x = Conv2D(int(kernels), (3), activation=&#x27;relu&#x27;, padding=&#x27;same&#x27;)(x)</span></span><br><span class="line"><span class="comment">### outputs = Conv2D(1, (3), activation=&#x27;relu&#x27;, padding=&#x27;same&#x27;)(x)</span></span><br><span class="line">outputs = Conv2D(output_channels, (<span class="number">3</span>), activation=<span class="string">&#x27;sigmoid&#x27;</span>, padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># instantiate decoder model</span></span><br><span class="line">decoder = Model(latent_inputs, outputs, name=<span class="string">&#x27;decoder&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># instantiate VAE model</span></span><br><span class="line">outputs = decoder(encoder(inputs)[<span class="number">2</span>])</span><br><span class="line">vae = Model(inputs, outputs, name=<span class="string">&#x27;vae_mlp&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">encoder.summary()</span><br><span class="line"><span class="comment"># plot_model(encoder, to_file=&#x27;vae_mlp_encoder.png&#x27;, show_shapes=True)</span></span><br><span class="line">decoder.summary()</span><br><span class="line"><span class="comment"># plot_model(decoder, to_file=&#x27;vae_mlp_deocer.png&#x27;, show_shapes=True)</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/1200/1*9RS6OYK6Fe5sRzaHwuW-ag.png"></p>
<p><img src="https://cdn-images-1.medium.com/max/1200/1*jRYAni0mgZIUSX6Jb3MtWw.png"></p>
<h3 id="Continue-with-loaded-model"><a href="#Continue-with-loaded-model" class="headerlink" title="Continue with loaded model"></a>Continue with loaded model</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">models = (encoder, decoder)</span><br><span class="line">data = (x_test, y_test)</span><br><span class="line"></span><br><span class="line">args_mse = <span class="literal">True</span></span><br><span class="line"><span class="comment"># VAE loss =mse_loss or xent_loss + kl_loss</span></span><br><span class="line"><span class="keyword">if</span> args_mse:</span><br><span class="line">  reconstruction_loss = mse(inputs, outputs)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  reconstruction_loss = binary_crossentropy(inputs, outputs)</span><br><span class="line"></span><br><span class="line">m = input_shape[<span class="number">0</span>]*input_shape[<span class="number">1</span>]</span><br><span class="line">reconstruction_loss *= m <span class="comment"># 28x28 values</span></span><br><span class="line">reconstruction_loss = K.<span class="built_in">sum</span>(reconstruction_loss)</span><br><span class="line">kl_loss = <span class="number">1</span> + z_log_var - K.square(z_mean) - K.exp(z_log_var)</span><br><span class="line">kl_loss = K.<span class="built_in">sum</span>(kl_loss, axis=<span class="number">-1</span>)</span><br><span class="line">kl_loss *= <span class="number">-0.5</span></span><br><span class="line">vae_loss = K.mean(reconstruction_loss + kl_loss)</span><br><span class="line">vae_loss /= m</span><br><span class="line">vae_loss /= m</span><br><span class="line">vae.add_loss(vae_loss)</span><br><span class="line">vae.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"><span class="comment"># vae.summary()</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">batch_size = <span class="number">128</span>*<span class="number">2</span>*<span class="number">2</span></span><br><span class="line">epochs = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># history = vae.fit(x_train[0:1000], epochs=epochs, shuffle=True, batch_size=batch_size, validation_data=(x_test, None))</span></span><br><span class="line">history = vae.fit(x_train, epochs=epochs, shuffle=<span class="literal">True</span>, batch_size=batch_size, validation_data=(x_test, <span class="literal">None</span>))</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*RmCmXW1ciIOz5fEMmrLezA.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># How did we go?</span></span><br><span class="line">loss = history.history[<span class="string">&quot;loss&quot;</span>]</span><br><span class="line">val_loss = history.history[<span class="string">&quot;val_loss&quot;</span>]</span><br><span class="line"></span><br><span class="line">epochs_array = <span class="built_in">list</span>(<span class="built_in">range</span>(epochs))</span><br><span class="line">plt.plot(epochs_array, loss, label=<span class="string">&quot;loss&quot;</span>)</span><br><span class="line">plt.plot(epochs_array, val_loss, label=<span class="string">&quot;val_loss&quot;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Plot:&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*ulmp1AJaJUSJ-8bAWJXMLA.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_model</span>(<span class="params">model, name</span>):</span></span><br><span class="line">  model_json = model.to_json()</span><br><span class="line">  <span class="keyword">with</span> <span class="built_in">open</span>(name+<span class="string">&quot;.json&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> json_file:</span><br><span class="line">    json.dump(model_json, json_file)</span><br><span class="line"></span><br><span class="line">  model.save_weights(name+<span class="string">&quot;.h5&quot;</span>)</span><br><span class="line"></span><br><span class="line">save_model(encoder, <span class="string">&#x27;encoder_mnist&#x27;</span>)</span><br><span class="line">save_model(decoder, <span class="string">&#x27;decoder_mnist&#x27;</span>)</span><br><span class="line"><span class="comment"># save_model(encoder, &#x27;encoder_draw_100ep&#x27;)</span></span><br><span class="line"><span class="comment"># save_model(decoder, &#x27;decoder_draw_100ep&#x27;)</span></span><br></pre></td></tr></table></figure>

<h3 id="Now-let’s-use-it"><a href="#Now-let’s-use-it" class="headerlink" title="Now let’s use it!"></a>Now let’s use it!</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We can carry these files (*.h5, *.json) somewhere else ...</span></span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> load_model</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> model_from_json</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_load_model</span>(<span class="params">name</span>):</span></span><br><span class="line">  <span class="keyword">with</span> <span class="built_in">open</span>(name+<span class="string">&#x27;.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">      model_json = json.load(f)</span><br><span class="line"></span><br><span class="line">  model =model_from_json(model_json)</span><br><span class="line">  model.load_weights(name+<span class="string">&#x27;.h5&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line">decoder = my_load_model(<span class="string">&#x27;decoder_mnist&#x27;</span>)</span><br><span class="line">encoder = my_load_model(<span class="string">&#x27;encoder_mnist&#x27;</span>)</span><br><span class="line"><span class="comment"># decoder = my_load_model(&#x27;decoder_draw_100ep&#x27;)</span></span><br><span class="line"><span class="comment"># encoder = my_load_model(&#x27;encoder_draw_100ep&#x27;)</span></span><br></pre></td></tr></table></figure>

<h3 id="Inspect-one-in-detail"><a href="#Inspect-one-in-detail" class="headerlink" title="Inspect one in detail:"></a>Inspect one in detail:</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Encoded image:</span></span><br><span class="line">x1 = x_test[<span class="number">73</span>]</span><br><span class="line">print(x1.shape)</span><br><span class="line">print(np.<span class="built_in">max</span>(x1), np.<span class="built_in">min</span>(x1), np.mean(x1))</span><br><span class="line"></span><br><span class="line">img = x1[:,:,<span class="number">0</span>] <span class="comment">#&lt; for mnist</span></span><br><span class="line"><span class="comment"># img = x1[:,:] #&lt; for cifar</span></span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">4</span>,<span class="number">4</span>))</span><br><span class="line">plt.imshow(img, cmap=<span class="string">&#x27;gray&#x27;</span>, vmin=<span class="number">0.0</span>, vmax=<span class="number">1.0</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*UlvWYAiTbBHEJm8Ltzp59g.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Latent vector:</span></span><br><span class="line"></span><br><span class="line">x1_arr = np.asarray([x1])</span><br><span class="line">z, z_mean, z_log_var = encoder.predict(x1_arr)</span><br><span class="line">print(z.shape)</span><br><span class="line">print(np.<span class="built_in">max</span>(z), np.<span class="built_in">min</span>(z), np.mean(z))</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">16</span>,<span class="number">4</span>))</span><br><span class="line">plt.plot(z[<span class="number">0</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*Y9fLN5jHxXCGkKqfKP6csg.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Reconstructed image</span></span><br><span class="line"></span><br><span class="line">y1 = decoder.predict(z)</span><br><span class="line">print(y1.shape)</span><br><span class="line">y1 = y1[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">img = y1[:,:,<span class="number">0</span>] <span class="comment">#&lt; for mnist</span></span><br><span class="line"><span class="comment"># img = y1[:,:] #&lt; for cifar</span></span><br><span class="line">print(np.<span class="built_in">max</span>(y1), np.<span class="built_in">min</span>(y1), np.mean(y1))</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">4</span>,<span class="number">4</span>))</span><br><span class="line">plt.imshow(img, cmap=<span class="string">&#x27;gray&#x27;</span>, vmin=<span class="number">0.0</span>, vmax=<span class="number">1.0</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*f7zrOINhdqdtHX-LLGSn-Q.png"></p>
<h3 id="Or-in-triplets"><a href="#Or-in-triplets" class="headerlink" title="Or in triplets:"></a>Or in triplets:</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_tripple</span>(<span class="params">image, vector, reconstruction</span>):</span></span><br><span class="line">  fig, (ax1, ax2, ax3) = plt.subplots(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">  fig.suptitle(<span class="string">&#x27;Image &gt; Representation &gt; Reconstruction&#x27;</span>)</span><br><span class="line">  ax1.imshow(image, cmap=<span class="string">&#x27;gray&#x27;</span>, vmin=<span class="number">0.0</span>, vmax=<span class="number">1.0</span>)</span><br><span class="line">  ax2.plot(vector)</span><br><span class="line">  ax2.set_aspect(<span class="number">3.1</span>)</span><br><span class="line">  ax3.imshow(reconstruction, cmap=<span class="string">&#x27;gray&#x27;</span>, vmin=<span class="number">0.0</span>, vmax=<span class="number">1.0</span>)</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_single</span>(<span class="params">image</span>):</span></span><br><span class="line">  plt.figure(figsize=(<span class="number">1</span>,<span class="number">1</span>))</span><br><span class="line">  plt.imshow(image, cmap=<span class="string">&#x27;gray&#x27;</span>, vmin=<span class="number">0.0</span>, vmax=<span class="number">1.0</span>)</span><br><span class="line">  plt.show()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x1 = x_test[<span class="number">9</span>] <span class="comment"># 2 has a &#x27;1&#x27;, 3 has a &#x27;0&#x27;</span></span><br><span class="line">z, z_mean, z_log_var = encoder.predict(np.asarray([x1]))</span><br><span class="line">y1 = decoder.predict(z)</span><br><span class="line"></span><br><span class="line">plot_tripple(x1[:,:,<span class="number">0</span>], z[<span class="number">0</span>], y1[<span class="number">0</span>,:,:,<span class="number">0</span>])</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*qAzzfcrU1X2esmHjNJ1nYw.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    x1 = x_test[randrange(<span class="built_in">len</span>(x_test))]</span><br><span class="line">    z, z_mean, z_log_var = encoder.predict(np.asarray([x1]))</span><br><span class="line">    y1 = decoder.predict(z)</span><br><span class="line">    plot_tripple(x1[:,:,<span class="number">0</span>], z[<span class="number">0</span>], y1[<span class="number">0</span>,:,:,<span class="number">0</span>])</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/1200/1*-ouwY1PwL0upUhhZtja3fA.png"></p>
<p><img src="https://cdn-images-1.medium.com/max/1200/1*ZxC7L3s82t-auaaDbWIdUA.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sample_a = x_test[<span class="number">2</span>] <span class="comment"># 2 jas a &#x27;1&#x27;</span></span><br><span class="line">z_sample_a_encoded, _, _ = encoder.predict(np.asarray([sample_a]))</span><br><span class="line"></span><br><span class="line">sample_b = x_test[<span class="number">3</span>] <span class="comment"># 3 jas a &#x27;0&#x27;</span></span><br><span class="line">z_sample_b_encoded, _, _ = encoder.predict(np.asarray([sample_b]))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;z_sample_a_encoded:&quot;</span>, z_sample_a_encoded.shape)</span><br><span class="line">print(<span class="string">&quot;z_sample_b_encoded:&quot;</span>, z_sample_b_encoded.shape)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>z_sample_a_encoded: (1, 32) </p>
<p>z_sample_b_encoded: (1, 32)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">plt.plot(z_sample_a_encoded[<span class="number">0</span>])</span><br><span class="line">plt.show()</span><br><span class="line">plt.plot(z_sample_b_encoded[<span class="number">0</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*yMEEJlN0M8jFNpTG0sqL_w.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lerp</span>(<span class="params">u, v, a</span>):</span></span><br><span class="line">  <span class="comment"># linear interpolation between vectors u and v</span></span><br><span class="line">  <span class="keyword">return</span> a*u + (<span class="number">1</span>-a)*v</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0.5</span></span><br><span class="line">z_mix = lerp(z_sample_a_encoded, z_sample_b_encoded, a)</span><br><span class="line"></span><br><span class="line">image = decoder.predict(z_mix) <span class="comment"># shape comes as (1,28,28,1)</span></span><br><span class="line">image = image.reshape((<span class="number">28</span>,<span class="number">28</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plot_single(image)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">steps = <span class="number">5</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (steps + <span class="number">1</span>):</span><br><span class="line">  <span class="comment"># Goes from 0.0 to 1.0 in &lt;steps&gt; steps</span></span><br><span class="line">  a_01 = <span class="built_in">float</span>(i) / <span class="built_in">float</span>(steps)</span><br><span class="line">  z_mix = lerp(z_sample_a_encoded, z_sample_b_encoded, a_01)</span><br><span class="line">  y = decoder.predict(z_mix)</span><br><span class="line">  image = y.reshape((<span class="number">28</span>,<span class="number">28</span>))</span><br><span class="line">  print(a_01, <span class="string">&quot;:&quot;</span>)</span><br><span class="line">  plot_single(image)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#@title Control over the VAE we just trained:</span></span><br><span class="line"><span class="keyword">from</span> IPython.utils <span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">first_sample_idx = <span class="number">200</span> <span class="comment">#@param &#123;type:&quot;integer&quot;&#125;</span></span><br><span class="line">second_sample_idx = <span class="number">5360</span> <span class="comment">#@param &#123;type:&quot;integer&quot;&#125;</span></span><br><span class="line">interpolation = <span class="number">0.21</span> <span class="comment">#@param &#123;type:&quot;slider&quot;, min:0.0, max:1.0, step:0.01&#125;</span></span><br><span class="line"></span><br><span class="line">sample_a = x_test[first_sample_idx] <span class="comment"># 2 has a &#x27;1&#x27;</span></span><br><span class="line">z_sample_a_encoded, _, _ = encoder.predict(np.asarray([sample_a]))</span><br><span class="line"></span><br><span class="line">sample_b = x_test[second_sample_idx] <span class="comment"># 3 has a &#x27;0&#x27;</span></span><br><span class="line">z_sample_b_encoded, _, _ = encoder.predict(np.asarray([sample_b]))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;z_sample_a_encoded:&quot;</span>, z_sample_a_encoded.shape)</span><br><span class="line">print(<span class="string">&quot;z_sample_b_encoded:&quot;</span>, z_sample_b_encoded.shape)</span><br><span class="line">print(<span class="string">&quot;a:&quot;</span>, interpolation)</span><br><span class="line"></span><br><span class="line">z_mix = lerp(z_sample_a_encoded, z_sample_b_encoded, interpolation)</span><br><span class="line">image = decoder.predict(z_mix) <span class="comment"># shape comes as (1,28,28,1)</span></span><br><span class="line">image = image.reshape((<span class="number">28</span>,<span class="number">28</span>))</span><br><span class="line"></span><br><span class="line">plot_single(image)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*XWW9qneyLjZpdkm79nftDg.png"></p>
<h3 id="Random-vector-to-image"><a href="#Random-vector-to-image" class="headerlink" title="Random vector to image"></a>Random vector to image</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Random latent</span></span><br><span class="line">latent = np.random.randn(<span class="number">1</span>, <span class="number">32</span>)*<span class="number">32</span></span><br><span class="line">print(<span class="string">&quot;latent = &quot;</span>, latent)</span><br><span class="line"></span><br><span class="line">image = decoder.predict(latent)</span><br><span class="line">image = image.reshape((<span class="number">28</span>,<span class="number">28</span>))</span><br><span class="line"></span><br><span class="line">plot_single(image)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We can try break it ...</span></span><br><span class="line"></span><br><span class="line">latent = np.zeros(<span class="number">32</span>)</span><br><span class="line">latent[<span class="number">0</span>] = <span class="number">999.0</span> <span class="comment"># oversaturated</span></span><br><span class="line">print(<span class="string">&quot;latent = &quot;</span>, latent)</span><br><span class="line"></span><br><span class="line">image = decoder.predict(latent.reshape(<span class="number">1</span>,<span class="number">32</span>))</span><br><span class="line">image = image.reshape((<span class="number">28</span>,<span class="number">28</span>))</span><br><span class="line"></span><br><span class="line">plot_single(image)</span><br></pre></td></tr></table></figure>

<h3 id="Visualization-as-a-gif"><a href="#Visualization-as-a-gif" class="headerlink" title="Visualization as a gif:"></a>Visualization as a gif:</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!pip install imageio</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> cv2import imageio, <span class="keyword">global</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#linear interpolation function</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">x</span>):</span></span><br><span class="line">  <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">interpolate</span>(<span class="params">size = <span class="number">10</span></span>):</span></span><br><span class="line">  <span class="keyword">if</span> os.path.exists(<span class="string">&quot;images&quot;</span>):</span><br><span class="line">    shutil.rmtree(<span class="string">&quot;images&quot;</span>)</span><br><span class="line">    os.makedirs(<span class="string">&#x27;images&#x27;</span>)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    os.kaedirs(<span class="string">&#x27;images&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># get 3 random batches each of size 3</span></span><br><span class="line">  batches = []</span><br><span class="line">  <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">3</span>):</span><br><span class="line">    i1 = np.random.randint(<span class="number">0</span>, <span class="built_in">len</span>(x_train))</span><br><span class="line">    i2 = np.random.randint(<span class="number">0</span>, <span class="built_in">len</span>(x_train))</span><br><span class="line">    batches.append([x_train[i1:i1+<span class="number">3</span>], x_train[i2:i2+<span class="number">3</span>]])</span><br><span class="line"></span><br><span class="line">  i = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">list</span>(np.linspace(<span class="number">0</span>, <span class="number">1</span>, size)):</span><br><span class="line">    frame = <span class="literal">None</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># interpolate each batch and concatenate them at the end to create 3x3 images</span></span><br><span class="line">    <span class="keyword">for</span> (x1, x2) <span class="keyword">in</span> batches:</span><br><span class="line"></span><br><span class="line">      v1,_,_ = encoder.predict(x1)</span><br><span class="line">      v2,_,_ = encoder.predict(x2)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># use a linear interpolater</span></span><br><span class="line">      v = (<span class="built_in">float</span>(x))*v1 + (<span class="number">1.0</span> = <span class="built_in">float</span>(x))*v2</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># get the output and reshape it</span></span><br><span class="line">      y = decoder.predict(v)</span><br><span class="line">      img = np.reshape(y, (<span class="number">3</span> * <span class="number">28</span>, <span class="number">28</span>))</span><br><span class="line">      img = img * <span class="number">255</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># concatenate the batches</span></span><br><span class="line">      <span class="keyword">if</span> frame <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        frame = img</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        frame = np.concatenate([frame, img], axis = <span class="number">1</span>)</span><br><span class="line">      j += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># write the current frame to the dist</span></span><br><span class="line">      frame = cv2.resize(frame, (<span class="number">256</span>,<span class="number">256</span>))</span><br><span class="line">      cv2.imwrite(<span class="string">f&#x27;images/image<span class="subst">&#123;i&#125;</span>.png&#x27;</span>, frame)</span><br><span class="line">      i+=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">!mkdir images</span><br><span class="line">!ls images</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">interpolate(size = <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> imageio.get_writer(<span class="string">&#x27;lsi.gif&#x27;</span>, mode=<span class="string">&#x27;I&#x27;</span>, duration=<span class="number">0.35</span>) <span class="keyword">as</span> writer:</span><br><span class="line">  filenames = glob.glob(<span class="string">&#x27;images/image*.png&#x27;</span>)</span><br><span class="line">  filenames = <span class="built_in">sorted</span>(filenames)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i, filename <span class="keyword">in</span> <span class="built_in">enumerate</span>(filenames):</span><br><span class="line">    image = imageio.imread(filename)</span><br><span class="line">    writer.append_data(image)</span><br><span class="line"></span><br><span class="line"><span class="comment"># this is a hack to display the gif inside the notebook</span></span><br><span class="line">os.system(<span class="string">&#x27;cp lsi.gif lsi.gif.png&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> IPython <span class="keyword">import</span> display</span><br><span class="line">display.Image(filename=<span class="string">&quot;lsi.gif.png&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn-images-1.medium.com/max/800/1*bFzqjxuj-OyzsV_URW3Vlg.gif"></p>

    </div>

    <div class="about">
        <h1>About this Post</h1>
        <p>This post is written by Siqi Shu, licensed under <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>
</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">深智一物 眾隱皆變</h4>
                
            </div>
            
        </div>
        &copy; 2024 Siqi Shu<br />
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
<script src="/js/kursor.js"></script>

        
<script src="/js/run.js"></script>


    </body>
</html>
